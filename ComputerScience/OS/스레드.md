## 스레드의 개념

### 정의

프로세스의 코드에 정의된 절차에 따라 CPU에 작업 요청을 하는 실행단위이다.

CPU 스케줄러는 프로세스가 생성되면 프로세스가 해야 할 일은 CPU에 전달하고 실제 작업은 CPU가 수행한다. 이때 CPU에 전달하는 일 하나가 스레드이다.

- 운영체제의 작업 단위: `프로세스`
- CPU의 작업 단위: `스레드`



### 프로세스와 스레드의 차이

#### 프로세스

- 프로세스 간 <u>약하게</u> 연결됐다.
- 고유의 공간과 자원이 있다.
  - 데이터를 주고받을 때 **프로세스 간 통신(Inter Process Communication, IPC)** 을 이용한다.
- 프로세스 간 순서에 영향을 받지 않고 독립적으로 동작한다.



#### 스레드

- 스레드 간 <u>강하게</u> 연결됐다.

- 공간과 자원을 공유하고 있다.
  - `전역 변수`나` 함수 호출` 등의 방법으로 스레드 간 통신을 한다.
- 스레드 간 순서가 중요하다.



### 관련 용어

#### 멀티스레드

- 프로세스 내 작업을 여러 개의 스레드로 분할함으로써 작업 부담을 줄이는 프로세스 운영기법이다.



#### 멀티태스킹

- 운영체제가 CPU에 작업을 줄 때 시간을 잘게 나누어 배분하는 기법이다.
- 시분할 시스템
  - 여러 스레드에 시간을 잘게 나누어주는 시스템



#### 멀티프로세싱

- 여러 개의 CPU 혹은 하나의 CPU내 여러 개의 코어로 여러 개의 스레드를 동시에 처리하는 작업 환경이다.
  - 병렬처리에서 슈퍼 스칼라 기법과 같다.



#### CPU 멀티스레드

- 파이프라인 기법을 이용하여 동시에 여러 스레드를 처리하도록 만든 병렬 처리 기법이다.
- 하나의 CPU에서 처리한다.
- 멀티스레드와 차이점
  - 멀티스레드: 운영체제가 `소프트웨어`적으로 프로세스를 작은 단위의 스레드로 분할하여 운영하는 기법
  - CPU 멀티스레드: `하드웨어`적인 방법으로 하나의 CPU에서 여러 스레드를 동시에 처리하는 병렬 처리 기법



## 멀티스레드

### 구조

`fork()` 와 `exe()` 시스템 호출의 경우 코드와 데이터가 중복되어 메모리가 낭비된다. 하지만 멀티프로세스는 코드, 데이터를 공유하면서 여러 개의 일을 하나의 프로세스 내에서 하는 것이다. 프로세서는 정적인 영역과 동적인 영역으로 구분된다. 

- 정적 영역: 프로세스가 실행되는 동안 바뀌지 않는 영역
- 동적 영역: 스레드가 작업을 하면서 값이 바뀌거나 새로 만들어지거나 사라지는 영역



### 장단점

#### 장점

- 응답성 향상

  한 스레드가 입출력으로 인해 작업이 진행되지 않아도 다른 스레드가 작업을 계속하여 사용자의 작업 요구에 빨리 응답할 수 있다.

- 자원 공유

  프로세스 내에서 생성된 독립적인 스레드는 프로세스가 가진 자원을 모두 공유할 수 있다.

- 효율성 향상

  불필요한 자원의 중복을 막을 수 있다.

- 다중 CPU 지원

  2개 이상의 CPU를 가진 컴퓨터에서 멀티스레스를 사용하면 다중 CPU가 멀티스레드를 동시에 처리한다. 따라서 CPU 사용량의 증가하고 프로세스의 처리 시간이 단축된다.



#### 단점

- 모든 스레드가 자원을 공유하고 있기 때문에 한 스레드가 문제 생기면 프로세스 전체에 영향을 미친다.



#### 활용 예시

`인터넷 익스플로어`의 경우 멀티스레드를 사용하고, `크롬`의 경우엔 멀티태스킹을 사용한다. 

- 멀티태스킹을 사용하는 이유는 스레드 간 영향을 최소화하기 위함이다. 요즘은 메모리가 넉넉하고 멀티코어 CPU를 사용하므로 여러 개의 프로세스를 여러 개의 CPU에서 동시에 실행할 수 있다.



### 멀티스레드 모델

#### 종류

스레드는 `커널 스레드`와 `사용자 스레드`로 나뉜다.

- 커널 스레드

  커널이 직접 생성하고 관리하는 스레드

- 사용자 스레드

  라이브러리에 의해 구현된 일반적인 스레드



#### 분류

> 사용자 스레드가 커널 스레드를 사용하려면 시스템 호출로 커널 기능을 이용해야한다. 이때 커널 스레드와 사용자 스레드의 대응 방식에 따라 다음과 같이 분류된다.

##### 사용자 스레드

- 특징
  - 운영체제가 멀티스레드 미지원시 사용
  - 사용자 레벨에서 구현하므로 라이브러리 사용
    - 라이브러리가 커널이 지원하는 스케줄링, 동기화 기능 대신 구현
    - 커널 입장에선 하나의 프로세스처럼 보이는 스레드이다.
  - `1 to N`
    - 다수의 사용자 스레드가 하나의 커널 스레드와 연결
- 장점
  - 문맥교환이 없기 때문에 <u>속도가 빠르다</u>.
    - 커널에서 문맥 교환이 필요한 이유는 시간을 나누어 서로 다른 프로세스를 처리하기 위해서이다. 하지만 라이브러리가 직접 스케줄링하고 작업에 필요한 정보를 처리하기 때문에 문맥교환이 필요없다.
- 단점
  - 커널 스레드가 입출력 작업을 위해 대기 상태에 들어가면 모든 사용자 스레드가 <u>같이 대기</u>해야한다.
  - 한 프로세스의 타임 슬라이스를 여러 스레드가 공유하고 있기 때문에 <u>여러 개의 CPU를 동시에 사용할 수 없다.</u>
    - 커널 입장에서 사용자 스레드는 하나의 프로세스로 인식되므로 작업을 나눌 수 없다.



##### 커널 스레드

- 특징
  - 커널이 멀티스레드를 지원하는 방식
  - `1 to 1`
    - 하나의 사용자 스레드가 하나의 커널 스레드와 연결

- 장점
  - `멀티 CPU`를 사용 가능
  - 하나의 스레드가 대기상태에 있어도 다른 스레드 작업 가능
  - 커널 기능 사용으로 <u>보안에 강하고 안정적</u>으로 작동
- 단점
  - `문맥 교환` 시 오버헤드 때문에 느리다.



##### 멀티레벨 스레드

- 특징
  - 사용자 스레드와 커널 스레드의 혼합 방식
  - `M to N`
    - 커널 스레드 <= 사용자 스레드
- 장점
  - 사용자 스레드보다 유연하게 작업 처리
    - 하나의 커널 스레드가 대기 상태에 들어가면 다른 커널 스레드가 대신 작업하기 때문이다.
- 단점
  - 문맥 교환 시 오버헤드가 있기 때문에 사용자 스레드보다 느리다.
    - 커널 스레드를 같이 사용하기 때문이다.
- 활용
  - 빠르게 움직여야 하는 스레드 => 사용자 스레드로 작동
  - 안정적으로 움직여야하는 스레드 => 커널 스레드로 작동



#### Refference

쉽게 배우는 운영체제 - 한빛아카데미